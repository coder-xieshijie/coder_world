![åŒäº²å§”æ´¾](https://coder-xieshijie-img-1253784930.cos.ap-beijing.myqcloud.com/img/2024/åŒäº²å§”æ´¾_5ff56beacaeaee35de86ae768ef5a5bb.jpg)



## é¢è¯•è¿ç¯call

1. **åŒäº²å§”æ´¾æœºåˆ¶**æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•**æ‰“ç ´**åŒäº²å§”æ´¾æœºåˆ¶ï¼Ÿ
2. JVMéƒ½æœ‰**å“ªäº›ç±»åŠ è½½å™¨**ï¼Ÿ
3. å¦‚ä½•æ„é€ ä¸€ä¸ª**è‡ªå®šä¹‰ç±»åŠ è½½å™¨**ï¼Ÿ
4. **Tomcat**çš„ç±»åŠ è½½æœºåˆ¶ï¼Ÿ**Spring**çš„ç±»åŠ è½½æœºåˆ¶
5. **Class.forName**()å’ŒClassLoader.**loadClass**()åŒºåˆ«?



åœ¨å¼€å§‹è®²è¿°ä¹‹å‰ç®€å•å›é¡¾ä¸€ä¸‹ä¹‹å‰çš„ç±»åŠ è½½è¿‡ç¨‹

- ç±»åŠ è½½è¿‡ç¨‹ï¼š**åŠ è½½->è¿æ¥->åˆå§‹åŒ–**ã€‚
- å…¶ä¸­**è¿æ¥**è¿‡ç¨‹åˆåˆ†ä¸ºï¼š**éªŒè¯->å‡†å¤‡->è§£æ**ã€‚

å…·ä½“å†…å®¹å¤§å®¶å¯ä»¥çœ‹æˆ‘ä¸Šä¸€ç¯‡å…³äºç±»åŠ è½½è¿‡ç¨‹çš„è¯¦ç»†ä»‹ç»



## ç±»åŠ è½½å™¨ä½œç”¨





**ç±»åŠ è½½å™¨çš„ä¸»è¦ä½œç”¨å°±æ˜¯åŠ è½½ Java ç±»çš„å­—èŠ‚ç ï¼ˆ `.class` æ–‡ä»¶ï¼‰åˆ° JVM ä¸­ï¼ˆåœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„ `Class` å¯¹è±¡ï¼‰ã€‚** 

å­—èŠ‚ç å¯ä»¥æ˜¯ Java æºç¨‹åºï¼ˆ`.java`æ–‡ä»¶ï¼‰ç»è¿‡ `javac` ç¼–è¯‘å¾—æ¥ï¼Œä¹Ÿå¯ä»¥æ˜¯é€šè¿‡å·¥å…·åŠ¨æ€ç”Ÿæˆæˆ–è€…é€šè¿‡ç½‘ç»œä¸‹è½½å¾—æ¥ã€‚

![image-20211030235925336](https://coder-xieshijie-img-1253784930.cos.ap-beijing.myqcloud.com/img/2024/1666682-20211031194951287-1778132123_dbbfdbcd30f4ec33467888fcc275b6fb.png)



> éœ€è¦æ³¨æ„çš„æ˜¯

- ç±»åŠ è½½å™¨æ˜¯ä¸€ä¸ª**è´Ÿè´£åŠ è½½ç±»çš„å¯¹è±¡**ï¼Œç”¨äºå®ç°ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„åŠ è½½è¿™ä¸€æ­¥ã€‚

- æ¯ä¸ª Java ç±»éƒ½æœ‰ä¸€ä¸ªå¼•ç”¨æŒ‡å‘åŠ è½½å®ƒçš„ `ClassLoader`ã€‚

- æ•°ç»„ç±»ä¸æ˜¯é€šè¿‡ `ClassLoader` åˆ›å»ºçš„ï¼ˆæ•°ç»„ç±»æ²¡æœ‰å¯¹åº”çš„äºŒè¿›åˆ¶å­—èŠ‚æµï¼‰ï¼Œæ˜¯ç”± JVM ç›´æ¥ç”Ÿæˆçš„ã€‚



> Class.forName()å’ŒClassLoader.loadClass()åŒºåˆ«?

- **Class.forName()**: å°†ç±»çš„.classæ–‡ä»¶åŠ è½½åˆ°jvmä¸­ä¹‹å¤–ï¼Œè¿˜ä¼šå¯¹**ç±»è¿›è¡Œè§£é‡Šï¼Œæ‰§è¡Œç±»ä¸­çš„staticå—**
- **ClassLoader.loadClass()**: åªæ˜¯**å°†.classæ–‡ä»¶åŠ è½½åˆ°jvm**ä¸­ï¼Œä¸ä¼šæ‰§è¡Œstaticä¸­çš„å†…å®¹, åªæœ‰åœ¨newInstanceæ‰ä¼šå»æ‰§è¡Œstaticä¸­å†…å®¹



## ç±»åŠ è½½å™¨åˆ†ç±»

1. `å¯åŠ¨ç±»åŠ è½½å™¨`: Bootstrap ClassLoaderï¼Œè´Ÿè´£åŠ è½½å­˜æ”¾åœ¨`JDK\jre\lib`(JDKä»£è¡¨JDKçš„å®‰è£…ç›®å½•ï¼Œä¸‹åŒ)ä¸‹ï¼Œæˆ–è¢«-Xbootclasspathå‚æ•°æŒ‡å®šçš„è·¯å¾„ä¸­çš„ï¼Œå¹¶ä¸”èƒ½è¢«è™šæ‹Ÿæœºè¯†åˆ«çš„ç±»åº“(å¦‚rt.jarï¼Œæ‰€æœ‰çš„**java.*å¼€å¤´çš„ç±»å‡è¢«Bootstrap ClassLoaderåŠ è½½**)ã€‚å¯åŠ¨ç±»åŠ è½½å™¨æ˜¯æ— æ³•è¢«Javaç¨‹åºç›´æ¥å¼•ç”¨çš„ã€‚

2. `æ‰©å±•ç±»åŠ è½½å™¨`: Extension ClassLoaderï¼Œè¯¥åŠ è½½å™¨ç”±`sun.misc.Launcher$ExtClassLoader`å®ç°ï¼Œå®ƒè´Ÿè´£åŠ è½½`JDK\jre\lib\ext`ç›®å½•ä¸­ï¼Œæˆ–è€…ç”±`java.ext.dirs`ç³»ç»Ÿå˜é‡æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“(**å¦‚javax.*å¼€å¤´çš„ç±»**)ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨ã€‚

3. `åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨`: Application ClassLoaderï¼Œè¯¥ç±»åŠ è½½å™¨ç”±`sun.misc.Launcher$AppClassLoader`æ¥å®ç°ï¼Œå®ƒè´Ÿè´£**åŠ è½½ç”¨æˆ·ç±»è·¯å¾„(ClassPath)æ‰€æŒ‡å®šçš„ç±»**ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥ç±»åŠ è½½å™¨ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰è¿‡è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªå°±æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚

åº”ç”¨ç¨‹åºéƒ½æ˜¯ç”±è¿™ä¸‰ç§ç±»åŠ è½½å™¨äº’ç›¸é…åˆè¿›è¡ŒåŠ è½½çš„ï¼Œå¦‚æœæœ‰å¿…è¦ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åŠ å…¥è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ã€‚


![åŒäº²å§”æ´¾æ¨¡å‹](https://coder-xieshijie-img-1253784930.cos.ap-beijing.myqcloud.com/img/2024/åŒäº²å§”æ´¾æ¨¡å‹_ec87ef382580ce077cf4fb4d2e0f04f4.png)



> ğŸŒˆ æ‹“å±•ä¸€ä¸‹ï¼š
- rt.jarï¼šrt ä»£è¡¨â€œRunTimeâ€ï¼Œ**rt.jaræ˜¯ Java åŸºç¡€ç±»åº“**ï¼ŒåŒ…å« Java doc é‡Œé¢çœ‹åˆ°çš„æ‰€æœ‰çš„ç±»çš„ç±»æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¸¸ç”¨å†…ç½®åº“ java.xxx.\*éƒ½åœ¨é‡Œé¢ï¼Œæ¯”å¦‚**java.util**.\*ã€**java.io**.\*ã€**java.nio**.\*ã€**java.lang**.\*ã€**java.sql**.\*ã€**java.math**.\*ã€‚
- Java 9 å¼•å…¥äº†**æ¨¡å—ç³»ç»Ÿ**ï¼Œå¹¶ä¸”ç•¥å¾®æ›´æ”¹äº†ä¸Šè¿°çš„ç±»åŠ è½½å™¨ã€‚æ‰©å±•ç±»åŠ è½½å™¨è¢«æ”¹åä¸º**å¹³å°ç±»åŠ è½½å™¨**ï¼ˆplatform class loaderï¼‰ã€‚Java SE ä¸­é™¤äº†å°‘æ•°å‡ ä¸ªå…³é”®æ¨¡å—ï¼Œæ¯”å¦‚è¯´ java.base æ˜¯ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½ä¹‹å¤–ï¼Œå…¶ä»–çš„æ¨¡å—å‡ç”±å¹³å°ç±»åŠ è½½å™¨æ‰€åŠ è½½ã€‚



## åŒäº²å§”æ´¾æœºåˆ¶

### å®šä¹‰

å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚ï¼Œå®ƒé¦–å…ˆ**ä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»**ï¼Œè€Œæ˜¯æŠŠè¯·æ±‚**å§”æ‰˜ç»™çˆ¶åŠ è½½å™¨**å»å®Œæˆï¼Œä¾æ¬¡å‘ä¸Šï¼Œå› æ­¤ï¼Œæ‰€æœ‰çš„ç±»åŠ è½½è¯·æ±‚**æœ€ç»ˆä¼šä¼ é€’åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨**ä¸­ï¼Œåªæœ‰å½“çˆ¶åŠ è½½å™¨åœ¨å®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»æ—¶ï¼Œå³æ— æ³•å®Œæˆè¯¥åŠ è½½ï¼Œå­ç±»åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½è¯¥ç±»ã€‚

> è¿™ç§ç±»åŠ è½½å™¨ä¹‹é—´çš„å±‚æ¬¡å…³ç³»è¢«ç§°ä¸ºç±»åŠ è½½å™¨çš„â€œ**åŒäº²å§”æ´¾æ¨¡å‹**(Parents Delegation Model)â€ã€‚




![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://coder-xieshijie-img-1253784930.cos.ap-beijing.myqcloud.com/img/2024/20210424152337921_185af2c641411d5fca5c48df0631f644.png)



### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨?

1. **é˜²æ­¢å†…å­˜ä¸­å‡ºç°å¤šä»½åŒæ ·çš„å­—èŠ‚ç **ã€‚å¦‚æœæ²¡æœ‰è¯¥æœºåˆ¶è€Œæ˜¯ç”±å„ä¸ªç±»åŠ è½½å™¨è‡ªè¡ŒåŠ è½½çš„è¯ï¼Œç”¨æˆ·ç¼–å†™äº†ä¸€ä¸ª`java.lang.Object`çš„åŒåç±»å¹¶æ”¾åœ¨`ClassPath`ä¸­ï¼Œå¤šä¸ªç±»åŠ è½½å™¨éƒ½èƒ½åŠ è½½è¿™ä¸ªç±»åˆ°å†…å­˜ä¸­ï¼Œç³»ç»Ÿä¸­å°†ä¼šå‡ºç°å¤šä¸ªä¸åŒçš„`Object`ç±»ï¼Œé‚£ä¹ˆç±»ä¹‹é—´çš„æ¯”è¾ƒç»“æœåŠç±»çš„å”¯ä¸€æ€§å°†æ— æ³•ä¿è¯ï¼ŒåŒæ—¶ï¼Œä¹Ÿä¼šç»™è™šæ‹Ÿæœºçš„å®‰å…¨å¸¦æ¥éšæ‚£ã€‚
2. åŒäº²å§”æ´¾æœºåˆ¶èƒ½å¤Ÿä¿è¯å¤šåŠ è½½å™¨åŠ è½½æŸä¸ªç±»æ—¶ï¼Œæœ€ç»ˆéƒ½æ˜¯ç”±ä¸€ä¸ªåŠ è½½å™¨åŠ è½½ï¼Œ**ç¡®ä¿æœ€ç»ˆåŠ è½½ç»“æœç›¸åŒ**ã€‚
3. è¿™æ ·å¯ä»¥ä¿è¯ç³»ç»Ÿåº“ä¼˜å…ˆåŠ è½½ï¼Œå³ä¾¿æ˜¯è‡ªå·±é‡å†™ï¼Œä¹Ÿæ€»æ˜¯ä½¿ç”¨Javaç³»ç»Ÿæä¾›çš„Systemï¼Œè‡ªå·±å†™çš„Systemç±»æ ¹æœ¬æ²¡æœ‰æœºä¼šå¾—åˆ°åŠ è½½ï¼Œä»è€Œ**ä¿è¯å®‰å…¨æ€§**ã€‚

**æ³¨æ„ âš ï¸**ï¼šåŒäº²å§”æ´¾æ¨¡å‹å¹¶ä¸æ˜¯ä¸€ç§å¼ºåˆ¶æ€§çš„çº¦æŸï¼Œåªæ˜¯ JDK å®˜æ–¹æ¨èçš„ä¸€ç§æ–¹å¼ã€‚å¦‚æœæˆ‘ä»¬å› ä¸ºæŸäº›ç‰¹æ®Šéœ€æ±‚æƒ³è¦æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹



### æ‰§è¡Œæµç¨‹

åŒäº²å§”æ´¾æ¨¡å‹çš„å®ç°ä»£ç éå¸¸ç®€å•ï¼Œé€»è¾‘éå¸¸æ¸…æ™°ï¼Œéƒ½é›†ä¸­åœ¨ `java.lang.ClassLoader` çš„ `loadClass()` ä¸­ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

```java
protected Class<?> loadClass(String name, boolean resolve)
    throws ClassNotFoundException
{
    synchronized (getClassLoadingLock(name)) {
        //é¦–å…ˆï¼Œæ£€æŸ¥è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡
        Class c = findLoadedClass(name);
        if (c == null) {
            //å¦‚æœ c ä¸º nullï¼Œåˆ™è¯´æ˜è¯¥ç±»æ²¡æœ‰è¢«åŠ è½½è¿‡
            long t0 = System.nanoTime();
            try {
                if (parent != null) {
                    //å½“çˆ¶ç±»çš„åŠ è½½å™¨ä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡çˆ¶ç±»çš„loadClassæ¥åŠ è½½è¯¥ç±»
                    c = parent.loadClass(name, false);
                } else {
                    //å½“çˆ¶ç±»çš„åŠ è½½å™¨ä¸ºç©ºï¼Œåˆ™è°ƒç”¨å¯åŠ¨ç±»åŠ è½½å™¨æ¥åŠ è½½è¯¥ç±»
                    c = findBootstrapClassOrNull(name);
                }
            } catch (ClassNotFoundException e) {
                //éç©ºçˆ¶ç±»çš„ç±»åŠ è½½å™¨æ— æ³•æ‰¾åˆ°ç›¸åº”çš„ç±»ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
            }

            if (c == null) {
                //å½“çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½æ—¶ï¼Œåˆ™è°ƒç”¨findClassæ–¹æ³•æ¥åŠ è½½è¯¥ç±»
                //ç”¨æˆ·å¯é€šè¿‡è¦†å†™è¯¥æ–¹æ³•ï¼Œæ¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨
                long t1 = System.nanoTime();
                c = findClass(name);

                //ç”¨äºç»Ÿè®¡ç±»åŠ è½½å™¨ç›¸å…³çš„ä¿¡æ¯
                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                sun.misc.PerfCounter.getFindClasses().increment();
            }
        }
        if (resolve) {
            //å¯¹ç±»è¿›è¡Œlinkæ“ä½œ
            resolveClass(c);
        }
        return c;
    }
}
```






## è‡ªå®šä¹‰ç±»åŠ è½½å™¨



æ„é€ è‡ªå®šä¹‰åŠ è½½å™¨ï¼Œéœ€è¦ç»§æ‰¿ `ClassLoader` ã€‚å¦‚æœæˆ‘ä»¬ä¸æƒ³æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Œå°±é‡å†™ `ClassLoader` ç±»ä¸­çš„ `findClass()` æ–¹æ³•å³å¯ï¼Œæ— æ³•è¢«çˆ¶ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æœ€ç»ˆä¼šé€šè¿‡è¿™ä¸ªæ–¹æ³•è¢«åŠ è½½ã€‚ä½†æ˜¯ï¼Œå¦‚æœæƒ³æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹åˆ™éœ€è¦é‡å†™ `loadClass()` æ–¹æ³•ã€‚

### ä¸ç ´ååŒäº²å§”æ´¾

å®ç°è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„å®ç°ï¼Œä¸»è¦åˆ†ä¸‰ä¸ªæ­¥éª¤

- åˆ›å»ºä¸€ä¸ªç±»ç»§æ‰¿ClassLoaderæŠ½è±¡ç±»
- é‡å†™findClass()æ–¹æ³•
- åœ¨findClass()æ–¹æ³•ä¸­è°ƒç”¨defineClass()

```java
public class MyClassLoader extends ClassLoader {

    private String classPath;

    public MyClassLoader(String classPath) {
        this.classPath = classPath;
    }

    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            byte[] bytes = getClassBytes(name);
            Class<?> c = this.defineClass(name, bytes, 0, bytes.length);
            return c;
        } catch (Exception e) {
            e.printStackTrace();
        }
        return super.findClass(name);
    }
  
    private byte[] getClassBytes(String name) throws Exception {
        name = name.replaceAll("\\.", "/");
        FileInputStream fis = new FileInputStream(classPath + "/" + name + ".class");
        int len = fis.available();
        byte[] data = new byte[len];
        fis.read(data);
        fis.close();
        return data;
    }
}

```



### ç ´ååŒäº²å§”æ´¾

å®šä¹‰`CoderWorldClass.java`æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨`javac`ç¼–è¯‘æˆ`.class`æ–‡ä»¶

```java
public class CoderWorldClass {
  public CoderWorldClass(){
     System.out.println("CoderWorldClass:"+getClass().getClassLoader());
     System.out.println("CoderWorldClass Parent:"+getClass().getClassLoader().getParent());
  }
  public String print(){
    System.out.println("CoderWorldClass method for print NEW");  //ä¿®æ”¹äº†æ‰“å°è¯­å¥ï¼Œç”¨æ¥åŒºåˆ†è¢«åŠ è½½çš„ç±»
    return "CoderWorldClass.print()";
  }
}

```



åœ¨MyClassLoaderç±»ä¸­ï¼Œé‡å†™`loadClass`æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹

```java
@Override
protected Class<?> loadClass(String name, boolean resolve) throws ClassNotFoundException {
  synchronized (getClassLoadingLock(name)) {
    // First, check if the class has already been loaded
    Class<?> c = findLoadedClass(name);
    if (c == null) {
      // If still not found, then invoke findClass in order
      // to find the class.
      long t1 = System.nanoTime();

      //éè‡ªå®šä¹‰çš„ç±»è¿˜æ˜¯èµ°åŒäº²å§”æ´¾åŠ è½½
      if (!name.equals("CoderWorldClass")) { 
        c = this.getParent().loadClass(name);
      } else { //è‡ªå·±å†™çš„ç±»ï¼Œèµ°è‡ªå·±çš„ç±»åŠ è½½å™¨ã€‚
        c = findClass(name);
      }
      // this is the defining class loader; record the stats
      sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
      sun.misc.PerfCounter.getFindClasses().increment();
    }
    if (resolve) {
      resolveClass(c);
    }
    return c;
  }
}
```

é€šè¿‡é‡å†™**loadClass**æ–¹æ³•ï¼Œä½¿å¾—è‡ªå·±åˆ›å»ºçš„ç±»ï¼Œè®©**ç¬¬ä¸€ä¸ªåŠ è½½å™¨ç›´æ¥åŠ è½½**ï¼Œä¸å§”æ‰˜çˆ¶åŠ è½½å™¨å¯»æ‰¾ï¼Œä»è€Œå®ç°åŒäº²å§”æ´¾çš„ç ´å



## Tomcatç±»åŠ è½½

> Tomcatæ˜¯å¦‚ä½•å®ç°åº”ç”¨jaråŒ…çš„éš”ç¦»çš„ï¼Ÿ



åœ¨æ€è€ƒè¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥æƒ³æƒ³Tomcatä½œä¸ºä¸€ä¸ªJSP/Servletå®¹å™¨ï¼Œå®ƒåº”è¯¥è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

1. ä¸€ä¸ªwebå®¹å™¨éœ€è¦éƒ¨ç½²å¤šä¸ªåº”ç”¨ç¨‹åºï¼Œä¸åŒçš„åº”ç”¨ç¨‹åºå¯èƒ½ä¼šä¾èµ–**åŒä¸€ä¸ªç¬¬ä¸‰æ–¹ç±»åº“çš„ä¸åŒç‰ˆæœ¬**ï¼Œä¸èƒ½è¦æ±‚åŒä¸€ä¸ªç±»åº“åœ¨åŒä¸€ä¸ªæœåŠ¡å™¨åªæœ‰ä¸€ä»½ï¼Œå› æ­¤è¦ä¿è¯æ¯ä¸ªåº”ç”¨ç¨‹åºçš„**ç±»åº“éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¿è¯ç›¸äº’éš”ç¦»**ã€‚
2. éƒ¨ç½²åœ¨åŒä¸€ä¸ªwebå®¹å™¨ä¸­**ç›¸åŒçš„ç±»åº“ç›¸åŒçš„ç‰ˆæœ¬å¯ä»¥å…±äº«**ã€‚å¦åˆ™ï¼Œå¦‚æœæœåŠ¡å™¨æœ‰10ä¸ªåº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆè¦æœ‰10ä»½ç›¸åŒçš„ç±»åº“åŠ è½½è¿›è™šæ‹Ÿæœºï¼Œå¿…ç„¶ä¼šå¸¦æ¥å†…å­˜æ¶ˆè€—è¿‡é«˜çš„é—®é¢˜ã€‚
3. webå®¹å™¨ä¹Ÿæœ‰è‡ªå·±ä¾èµ–çš„ç±»åº“ï¼Œä¸èƒ½ä¸åº”ç”¨ç¨‹åºçš„ç±»åº“æ··æ·†ã€‚åŸºäºå®‰å…¨è€ƒè™‘ï¼Œåº”è¯¥è®©**å®¹å™¨çš„ç±»åº“å’Œç¨‹åºçš„ç±»åº“éš”ç¦»å¼€**ã€‚



> Tomcatç±»åŠ è½½æœºåˆ¶

![è®¤è¯†Tomcatä¸­çš„ç±»åŠ è½½å™¨- whvixd | blog](https://whvixd.com/img/tomcat/tomcat_classloader.png)



- `Commonç±»åŠ è½½å™¨`ä½œä¸º `Catalinaç±»åŠ è½½å™¨` å’Œ `Sharedç±»åŠ è½½å™¨` çš„çˆ¶åŠ è½½å™¨ã€‚`Commonç±»åŠ è½½å™¨` èƒ½åŠ è½½çš„ç±»éƒ½å¯ä»¥è¢« `Catalinaç±»åŠ è½½å™¨` å’Œ `Sharedç±»åŠ è½½å™¨` ä½¿ç”¨ã€‚å› æ­¤ï¼Œ`Commonç±»åŠ è½½å™¨` æ˜¯ä¸ºäº†å®ç°å…¬å…±ç±»åº“ï¼ˆå¯ä»¥è¢«æ‰€æœ‰ Web åº”ç”¨å’Œ Tomcat å†…éƒ¨ç»„ä»¶ä½¿ç”¨çš„ç±»åº“ï¼‰çš„å…±äº«å’Œéš”ç¦»ã€‚

- `Catalinaç±»åŠ è½½å™¨` å’Œ `Sharedç±»åŠ è½½å™¨` èƒ½åŠ è½½çš„ç±»åˆ™ä¸å¯¹æ–¹ç›¸äº’éš”ç¦»ã€‚`Catalinaç±»åŠ è½½å™¨` ç”¨äºåŠ è½½ Tomcat è‡ªèº«çš„ç±»ï¼Œä¸ºäº†éš”ç¦» Tomcat æœ¬èº«çš„ç±»å’Œ Web åº”ç”¨çš„ç±»ã€‚
- `Sharedç±»åŠ è½½å™¨` ä½œä¸º `WebAppç±»åŠ è½½å™¨` çš„çˆ¶åŠ è½½å™¨ï¼Œä¸“é—¨æ¥åŠ è½½ Web åº”ç”¨ä¹‹é—´å…±äº«çš„ç±»æ¯”å¦‚ Springã€Mybatisã€‚

- æ¯ä¸ª Web åº”ç”¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ `WebAppç±»åŠ è½½å™¨`ï¼Œå¹¶åœ¨å¯åŠ¨ Web åº”ç”¨çš„çº¿ç¨‹é‡Œè®¾ç½®çº¿ç¨‹çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸º `WebAppClassLoader`ï¼Œå„ä¸ª `WebAppClassLoader` å®ä¾‹ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œè¿›è€Œå®ç° Web åº”ç”¨ä¹‹é—´çš„ç±»éš”ã€‚



> Tomcatå¦‚ä½•ç ´ååŒäº²å§”æ´¾?

å‡è®¾ Tomcat æœåŠ¡å™¨åŠ è½½äº†ä¸€ä¸ª Spring Jar åŒ…ã€‚é¡¹ç›®ä¸­ç”¨åˆ°çš„åŸºç¡€ç±»åº“ï¼Œç”±äºå…¶æ˜¯ Web åº”ç”¨ä¹‹é—´å…±äº«çš„ï¼Œå› æ­¤ä¼šç”± `SharedClassLoader` åŠ è½½ã€‚é¡¹ç›®ä¸­ä¸€äº›ç”¨åˆ°äº† Spring çš„ä¸šåŠ¡ç±»ï¼Œæ¯”å¦‚å®ç°äº† Spring æä¾›çš„æ¥å£ã€ç”¨åˆ°äº† Spring æä¾›çš„æ³¨è§£ã€‚æ‰€ä»¥ï¼ŒåŠ è½½ Spring çš„ç±»åŠ è½½å™¨ï¼ˆä¹Ÿå°±æ˜¯ `SharedClassLoader`ï¼‰ä¹Ÿä¼šç”¨æ¥åŠ è½½è¿™äº›ä¸šåŠ¡ç±»ã€‚ä½†æ˜¯ä¸šåŠ¡ç±»åœ¨ Web åº”ç”¨ç›®å½•ä¸‹ï¼Œä¸åœ¨ `SharedClassLoader` çš„åŠ è½½è·¯å¾„ä¸‹ï¼Œæ‰€ä»¥ `SharedClassLoader` æ— æ³•æ‰¾åˆ°ä¸šåŠ¡ç±»ï¼Œä¹Ÿå°±æ— æ³•åŠ è½½å®ƒä»¬ã€‚

å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ 

è¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ° **çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆ`ThreadContextClassLoader`ï¼‰** ã€‚

å½“ Spring éœ€è¦åŠ è½½ä¸šåŠ¡ç±»çš„æ—¶å€™ï¼Œå®ƒä¸æ˜¯ç”¨è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œè€Œæ˜¯ç”¨å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€‚è¿˜è®°å¾—æˆ‘ä¸Šé¢è¯´çš„å—ï¼Ÿæ¯ä¸ª Web åº”ç”¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ `WebAppClassLoader`ï¼Œå¹¶åœ¨å¯åŠ¨ Web åº”ç”¨çš„çº¿ç¨‹é‡Œè®¾ç½®çº¿ç¨‹çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸º `WebAppClassLoader`ã€‚è¿™æ ·å°±å¯ä»¥è®©é«˜å±‚çš„ç±»åŠ è½½å™¨ï¼ˆ`SharedClassLoader`ï¼‰å€ŸåŠ©å­ç±»åŠ è½½å™¨ï¼ˆ `WebAppClassLoader`ï¼‰æ¥åŠ è½½ä¸šåŠ¡ç±»ï¼Œä»è€Œç ´åäº† Java ç±»åŠ è½½çš„åŒäº²å§”æ‰˜æœºåˆ¶ã€‚


----


> å‚è€ƒå†…å®¹

[ååˆ†é’Ÿææ‡‚Javaç±»åŠ è½½](https://mp.weixin.qq.com/s?__biz=MzIxNzM0NjA1OQ==&mid=2247483698&idx=1&sn=6ab24416042310b91f9363fff3402370&chksm=97fa7856a08df140e0a97ad31cbfcc3b99d13741e1db365ea08ab307392f3d1b1535f2041fdb&token=471240037&lang=zh_CN#rd)

[Java ç±»åŠ è½½æœºåˆ¶](https://pdai.tech/md/java/jvm/java-jvm-classload.html)

[ç±»åŠ è½½å™¨è¯¦è§£(é‡ç‚¹)](https://javaguide.cn/java/jvm/classloader.html)

[ç±»åŠ è½½å™¨](https://blog.wangqi.love/articles/Java/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8.html)

[è¯·ä½ ç®€å•è¯´ä¸€ä¸‹ç±»åŠ è½½æœºåˆ¶çš„å®ç°åŸç†ï¼Ÿ ](https://www.cnblogs.com/mic112/p/15490566.html)
