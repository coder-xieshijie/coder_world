![image-20240707151924408](https://coder-xieshijie-img-1253784930.cos.ap-beijing.myqcloud.com/img/2024/image-20240707151924408_fa07c03e80185c563e4a1d9fc8930fe2.png)


> 哈喽，大家好🎉，我是**世杰**。
>
>
> 本文我为大家介绍面试官经常考察的**「Java对象创建流程」**



照例在开头留一些面试考察内容~~

## 面试连环call

1. Java对象创建的流程是什么样?
1. JVM执行new关键字时都有哪些操作?
1. JVM在频繁创建对象时，如何保证线程安全?
1. Java对象的内存布局是什么样的?
1. 对象头都存储哪些数据?

带着这些问题，让我们开始吧！🎉🎉🎉


-----


## 1. 对象创建流程

当虚拟机遇到一个字节码 **new 指令**的时候，首先去检查这个指令的参数是否能够在常量池中定位到一个类的符号引用。并且检查这个符号引用**代表的类**是否被虚拟机类**加载器加载**。如果没有，必须先执行类加载的流程。(PS:类加载的过程可以看我之前的文章)

new指令对应到语言层面上讲是，**new 关键词**、**对象克隆**、**对象序列化**等。



![类的生命周期](https://coder-xieshijie-img-1253784930.cos.ap-beijing.myqcloud.com/img/2024/01n2cq6mb3_733d56d3e5746842d033197e8afb9ee1.png)







> 在类的检查通过过后

1、虚拟机就会为**新生成对象分配内存**。对象所需要的内存大小在**类加载**的时候决定。

2、内存分配完成后，虚拟机会将这块分配到的内存空间(不包括对象头)都**初始化为零值**。

3、之后要进行对象进行初始化设置，比如**元数据**、对象的**哈希编码**、对象的 **GC 分代年龄**、**偏向锁状态**等信息这些信息都用于存放到**对象头(Object Header)**中。

4、执行 new 指令之后会接着执行构造器方法，把对象按照程序员的意愿进行**初始化（构造方法）**

这样一个真正可用的对象才算完全产生出来。



![image](https://coder-xieshijie-img-1253784930.cos.ap-beijing.myqcloud.com/img/2024/830289-20220116233158867-1686616621_6685ff4d733a78a02389496bff1578d2.png)



『总结对象创建的过程』

-   **类加载检查**
-   **分配内存**
-   **初始化零值**
-   **设置对象头**
-   **执行init方法，进行初始化**



----

## 2. 对象内存布局

在详细聊加载流程之前，先说说对象在**JVM堆中的内存布局**(这里讲的HotSpot虚拟机对象结构)

> 被JVM加载对象内部结构分为：**对象头**、**实例数据**、**对齐填充**。



![img](https://coder-xieshijie-img-1253784930.cos.ap-beijing.myqcloud.com/img/2024/20220712175658_66a7502d1b5572a13ef6822e77dd15c0.png)



### 2.1 对象头

- 对象标记（`Mark Word`），如**哈希码**（HashCode）、**GC分代年龄**、**锁状态标志**、**线程持有的锁**、**偏向线程ID**、**偏向时间戳等**。这部分我们称之为"Mard Word"。
- 类元信息（`Class Pointer`），即对象指向它的**类元数据的指针**，虚拟机通过这个指针来确定这个对象是哪个类的实例。
- 数组长度（`Length`），如果对象是一个Java数组，那在对象头中还必须有一块用于**记录数组长度的数据**，因为虚拟机可以通过普通Java对象的元数据信息确定Java对象的大小，但是从数组的元数据中无法确定数组的大小。



### 2.2 实例数据

- 实例数据部分是**对象真正存储的有效信息**，也是在程序代码中所定义的**各种类型的字段内容**。无论是从父类中继承下来的，还是在子类中定义的，都需要记录下来。HotSpot虚拟机默认的分配策略为longs/doubles、ints、shorts/chars、bytes/booleans、oop，从分配策略中可以看出，**相同宽度的字段总是分配到一起**。

- 存放**类的属性(Field)数据信息**，包括父类的属性信息，如果是数组的实例部分还包括数组的长度
- 这部分内存按**4字节对齐**。



### 2.3 内存填充/对齐填充

- 虚拟机要求对象起始地址必须是**8字节的整数倍**。填充数据不是必须存在的，仅仅是为了字节对齐。



----



## 3. 创建流程详解



创建对象在判断类加载之后，还会判断**内存是否规整**，根据判断结构选择使用**空闲列表**还是**指针碰撞**的内存分配方式，在分配内存时还会考虑**线程并发**处理，使用**CAS**或者是**TLAB**来处理，然后在执行初始化零值、设置对象头、执行\<init>方法







![img](https://coder-xieshijie-img-1253784930.cos.ap-beijing.myqcloud.com/img/2024/2443180-20211126084554203-1712031065_ed0f2cfc2f1cd0208f934366896033d2.png)



### 3.1 分配内存

类加载检查通过后，那就要为实例化的对象分配内存。对象所需内存的大小在**类加载完成后便完全确定**（对象内存布局），为对象分配空间的任务等同于把一块**确定大小**的内存从**Java堆**中划分出来。



**『分配方式』**

根据Java堆中是否规整有两种内存的分配方式：（Java堆是否规整由所采用的垃圾收集器是否带有压缩整理功能决定）

- **指针碰撞(Bump the pointer)** 
  Java堆中的内存是规整的，所有用过的内存都放在一边，空闲的内存放在另一边，中间放着一个指针作为分界点的指示器，分配内存也就是把指针向空闲空间那边移动一段与内存大小相等的距离。
- **空闲列表(Free List)**
  Java堆中的内存不是规整的，已使用的内存和空闲的内存相互交错，虚拟机维护一张列表，记录哪些内存块是可用的，在分配的时候从列表中找到一块足够大的空间划分给对象实例，并更新列表上的记录。



![b5654999074be8496a4208e703c259efc42ae8](https://coder-xieshijie-img-1253784930.cos.ap-beijing.myqcloud.com/img/2024/b5654999074be8496a4208e703c259efc42ae8_80742968e4b349e6eea3bafa1cc282ed.jpg)



**『并发处理』**

对象频繁分配的过程中，即使只修改一个指针所指向的位置，但是在并发的情况下也**不是线程安全**的，可能出现正在给 A 对象分配内存，指针还没有来得及修改，对象 B 又同时使用原来的指针进行内分配的情况。需要借助以下方式实现线程安全

- **CAS（compare and swap）**对分配内存空间的动作进行同步处理，虚拟机采用**CAS配上失败重试**的方式保证更新操作的原子性。
- **本地线程分配缓冲（Thread Local Allocation Buffer,TLAB）**，把内存分配的动作按照线程划分在不同的空间之中进行，即每个线程在Java堆中预先分配一小块内存。



### 3.2 初始化零值

内存分配完成后，虚拟机需要将分配到的内存空间都初始化为零值（**不包括对象头**），这里的零值是指**JAVA中字段默认的值**。 

- 如果使用TLAB，这一工作过程也可以提前至**TLAB分配**时进行。
- 这一步操作保证了**对象的实例字段**在Java代码中可以**不赋初始值就直接使用**，程序能访问到这些字段的数据类型所对应的零值。
- 注意这一步赋值是**对象实例字段**零值，跟类加载过程中**链接中的准备阶段**做区分，准备是为类**static变量赋零值**



### 3.3 设置对象头

初始化零值之后，虚拟机要对对象进行必要的设置，例如这个对象是哪个类的实例、如何才能找到类的元数据信息、对象的哈希码、对象的GC分代年龄等信息。**这些信息存放在对象的对象头Object Header之中**。



![对象内部结构](https://coder-xieshijie-img-1253784930.cos.ap-beijing.myqcloud.com/img/2024/20220712180601_e9575e389c294a82d1cfd2654c3a7c69.png)





### 3.4 执行init方法

完成上述流程，其实已经完成了虚拟机中内存的创建，但是我们在 Java **执行 new 创建对象**的角度才刚刚开始，我们还需要调用**构造方法初始化对象**(可能还需要在此前后调用父类的构造方法、初始化块等)。进行 Java 对象的初始化。



----



> 参考文章

[十分钟搞懂Java引用、对象和内存](https://mp.weixin.qq.com/s?__biz=MzIxNzM0NjA1OQ==&mid=2247483714&idx=1&sn=af3399aa741cd58a67a996d5581aeb76&chksm=97fa7826a08df13098bf56e5e747b6f94f441a8a34442e9e17ebe9925070bf595cc093fd1441&scene=126&sessionid=1720318895#rd)

[Java对象创建流程 ](https://www.cnblogs.com/dtyy/p/15811750.html)

[JVM 从入门到放弃之 Java 对象创建过程](https://www.51cto.com/article/705031.html)

[JAVA对象的创建及内存分配详解](https://www.cnblogs.com/xfeiyun/p/15600513.html)



























